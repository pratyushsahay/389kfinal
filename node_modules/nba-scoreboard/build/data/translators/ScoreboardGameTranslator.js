'use strict';
'use es6';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

var _immutable = require('immutable');

var _momentTimezone = require('moment-timezone');

var _momentTimezone2 = _interopRequireDefault(_momentTimezone);

var _jstimezonedetect = require('jstimezonedetect');

var _jstimezonedetect2 = _interopRequireDefault(_jstimezonedetect);

var _HtmlEscaper = require('../../utils/HtmlEscaper');

var _HtmlEscaper2 = _interopRequireDefault(_HtmlEscaper);

var _GameStatus = require('../models/GameStatus');

var _GameStatus2 = _interopRequireDefault(_GameStatus);

var _GameScoring = require('../models/GameScoring');

var _GameScoring2 = _interopRequireDefault(_GameScoring);

var _GameScoreboard = require('../models/GameScoreboard');

var _GameScoreboard2 = _interopRequireDefault(_GameScoreboard);

var _Constants = require('../../constants/Constants');

var _Constants2 = _interopRequireDefault(_Constants);

var _Location = require('../models/Location');

var _Location2 = _interopRequireDefault(_Location);

var _Period = require('../models/Period');

var _Period2 = _interopRequireDefault(_Period);

var _PeriodScore = require('../models/PeriodScore');

var _PeriodScore2 = _interopRequireDefault(_PeriodScore);

var _Score = require('../models/Score');

var _Score2 = _interopRequireDefault(_Score);

var _Matchup = require('../models/Matchup');

var _Matchup2 = _interopRequireDefault(_Matchup);

var _Team = require('../models/Team');

var _Team2 = _interopRequireDefault(_Team);

var _Broadcast = require('../models/Broadcast');

var _Broadcast2 = _interopRequireDefault(_Broadcast);

var _BroadcastMedium = require('../models/BroadcastMedium');

var _BroadcastMedium2 = _interopRequireDefault(_BroadcastMedium);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var ScoreboardGameTranslator = function () {
  function ScoreboardGameTranslator() {
    _classCallCheck(this, ScoreboardGameTranslator);
  }

  _createClass(ScoreboardGameTranslator, null, [{
    key: 'translate',
    value: function translate(data) {

      if (!('period_time' in data)) {
        throw new ReferenceError('period_time field missing');
      }

      if (!('broadcasters' in data)) {
        throw new ReferenceError('broadcasters field missing');
      }

      if (!('home' in data)) {
        throw new ReferenceError('home field missing');
      }

      if (!('visitor' in data)) {
        throw new ReferenceError('visitor field missing');
      }

      var periodTime = data.period_time;
      var broadcasters = data.broadcasters;
      var homeData = data.home;
      var awayData = data.visitor;

      return new _GameScoreboard2.default(data.id, ScoreboardGameTranslator.getGameStatus(periodTime), ScoreboardGameTranslator.getStartTimestamp(data), ScoreboardGameTranslator.getLocation(data), ScoreboardGameTranslator.getPeriod(periodTime), ScoreboardGameTranslator.getBroadcasts(broadcasters), ScoreboardGameTranslator.getMatchup(homeData, awayData), ScoreboardGameTranslator.getScoring(homeData, awayData));
    }
  }, {
    key: 'getGameStatus',
    value: function getGameStatus(periodTime) {
      if (!'game_status' in periodTime) {
        throw new ReferenceError('game_status field not in data');
      }

      var _iteratorNormalCompletion = true;
      var _didIteratorError = false;
      var _iteratorError = undefined;

      try {
        for (var _iterator = _GameStatus2.default.enumValues[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
          var status = _step.value;

          if (status.nbaStatsGameStatus == periodTime.game_status) {
            return status;
          }
        }
      } catch (err) {
        _didIteratorError = true;
        _iteratorError = err;
      } finally {
        try {
          if (!_iteratorNormalCompletion && _iterator.return) {
            _iterator.return();
          }
        } finally {
          if (_didIteratorError) {
            throw _iteratorError;
          }
        }
      }

      throw new ReferenceError('unknown nba stats game status');
    }
  }, {
    key: 'getStartTimestamp',
    value: function getStartTimestamp(gameData) {
      if (!('date' in gameData)) {
        throw new ReferenceError('date field missing');
      }

      if (!('time' in gameData)) {
        throw new ReferenceError('time field missing');
      }

      var rawStartTime = '' + gameData.date + gameData.time;

      return (0, _momentTimezone2.default)(rawStartTime, _Constants2.default.TRANSLATED_NBA_DATE_TIME_FORMAT).tz(_Constants2.default.DEFAULT_TIMEZONE).clone().tz("UTC").valueOf();
    }
  }, {
    key: 'getLocation',
    value: function getLocation(gameData) {
      if (!('arena' in gameData)) {
        throw new ReferenceError('arena field missing');
      }

      if (!('city' in gameData)) {
        throw new ReferenceError('city field missing');
      }

      if (!('state' in gameData)) {
        throw new ReferenceError('state field missing');
      }

      return new _Location2.default({
        arena: gameData.arena,
        city: gameData.city,
        state: gameData.state
      });
    }
  }, {
    key: 'getPeriod',
    value: function getPeriod(periodTime) {
      if (!('period_status' in periodTime)) {
        throw new ReferenceError('period_status field missing');
      }

      if (!('period_value' in periodTime)) {
        throw new ReferenceError('period_value field missing');
      }

      if (!('game_clock' in periodTime)) {
        throw new ReferenceError('game_clock field missing');
      }

      return new _Period2.default(parseInt(periodTime.period_value), periodTime.period_status, periodTime.game_clock);
    }
  }, {
    key: 'getBroadcasts',
    value: function getBroadcasts(broadcasters) {
      if (!('radio' in broadcasters)) {
        throw new ReferenceError('radio field missing');
      }

      if (!('tv' in broadcasters)) {
        throw new ReferenceError('tv field missing');
      }

      if (!('broadcaster' in broadcasters.radio)) {
        throw new ReferenceError('radio broadcasters field missing');
      }

      if (!('broadcaster' in broadcasters.tv)) {
        throw new ReferenceError('tv broadcasters field missing');
      }

      var broadcasts = [];
      var radioBroadcasters = broadcasters.radio.broadcaster;
      var tvBroadcasters = broadcasters.tv.broadcaster;

      radioBroadcasters.map(function (broadcast) {
        return broadcasts.push(ScoreboardGameTranslator.getBroadcast(broadcast, _BroadcastMedium2.default.RADIO));
      });

      tvBroadcasters.map(function (broadcast) {
        return broadcasts.push(ScoreboardGameTranslator.getBroadcast(broadcast, _BroadcastMedium2.default.TV));
      });

      return (0, _immutable.List)(broadcasts);
    }
  }, {
    key: 'getBroadcast',
    value: function getBroadcast(broadcast, medium) {
      if (!('scope' in broadcast)) {
        throw new ReferenceError('broadcast scope field missing');
      }

      if (!('display_name' in broadcast)) {
        throw new ReferenceError('broadcast display name field missing');
      }

      if (!(medium instanceof _BroadcastMedium2.default)) {
        throw new TypeError('medium must be a BroadcastMedium');
      }

      return new _Broadcast2.default(broadcast.scope, broadcast.display_name, medium);
    }
  }, {
    key: 'getMatchup',
    value: function getMatchup(homeData, awayData) {
      return new _Matchup2.default(ScoreboardGameTranslator.getTeam(homeData), ScoreboardGameTranslator.getTeam(awayData));
    }
  }, {
    key: 'getTeam',
    value: function getTeam(team) {
      if (!('city' in team)) {
        throw new ReferenceError('city field missing');
      }

      if (!('nickname' in team)) {
        throw new ReferenceError('nickname field missing');
      }

      if (!('abbreviation' in team)) {
        throw new ReferenceError('abbreviation field missing');
      }

      return new _Team2.default({
        city: team.city,
        nickname: team.nickname,
        abbreviation: team.abbreviation
      });
    }
  }, {
    key: 'getScoring',
    value: function getScoring(homeData, awayData) {
      return new _GameScoring2.default(ScoreboardGameTranslator.getPeriodScores(homeData, awayData), ScoreboardGameTranslator.getTotalScore(homeData, awayData));
    }
  }, {
    key: 'getPeriodScores',
    value: function getPeriodScores(homeData, awayData) {
      if (!('linescores' in homeData)) {
        throw new ReferenceError('home linescores field missing');
      }

      if (!('linescores' in awayData)) {
        throw new ReferenceError('away linescores field missing');
      }

      if (!'period' in homeData.linescores) {
        throw new ReferenceError('home period field missing');
      }

      if (!('period' in awayData.linescores)) {
        throw new ReferenceError('away period field missing');
      }

      var homePeriodScores = homeData.linescores.period;
      var awayPeriodScores = awayData.linescores.period;

      if (homePeriodScores.length != awayPeriodScores.length) {
        throw new Error('home period scores length is not equal to the away period scores length');
      }

      var periodScores = [];
      for (var index = 0; index < homePeriodScores.length; index++) {
        var homePeriodScore = homePeriodScores[index];
        var awayPeriodScore = awayPeriodScores[index];
        periodScores.push(ScoreboardGameTranslator.getPeriodScore(homePeriodScore, awayPeriodScore));
      }

      return (0, _immutable.List)(periodScores);
    }
  }, {
    key: 'getPeriodScore',
    value: function getPeriodScore(homePeriodScore, awayPeriodScore) {
      if (!('period_value' in homePeriodScore)) {
        throw new ReferenceError('home period value field missing');
      }

      if (!('score' in homePeriodScore)) {
        throw new ReferenceError('home score field missing');
      }

      if (!('period_value' in awayPeriodScore)) {
        throw new ReferenceError('away period value field missing');
      }

      if (!('score' in awayPeriodScore)) {
        throw new ReferenceError('away score field missing');
      }

      if (homePeriodScore.period_value != awayPeriodScore.period_value) {
        throw new ReferenceError('different period values');
      }

      return new _PeriodScore2.default({
        period: parseInt(homePeriodScore.period_value),
        score: new _Score2.default(parseInt(homePeriodScore.score), parseInt(awayPeriodScore.score))
      });
    }
  }, {
    key: 'getTotalScore',
    value: function getTotalScore(homeData, awayData) {
      if (!('score' in homeData)) {
        throw new ReferenceError('home score field missing');
      }

      if (!('score' in awayData)) {
        throw new ReferenceError('visitor score field missing');
      }

      return new _Score2.default(parseInt(homeData.score), parseInt(awayData.score));
    }
  }]);

  return ScoreboardGameTranslator;
}();

exports.default = ScoreboardGameTranslator;