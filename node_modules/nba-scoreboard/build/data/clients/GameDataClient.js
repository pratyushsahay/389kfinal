'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

var _momentTimezone = require('moment-timezone');

var _momentTimezone2 = _interopRequireDefault(_momentTimezone);

var _requestPromise = require('request-promise');

var _requestPromise2 = _interopRequireDefault(_requestPromise);

var _q = require('q');

var _q2 = _interopRequireDefault(_q);

var _BoxScoreClient = require('./BoxScoreClient');

var _BoxScoreClient2 = _interopRequireDefault(_BoxScoreClient);

var _PlayByPlayClient = require('./PlayByPlayClient');

var _PlayByPlayClient2 = _interopRequireDefault(_PlayByPlayClient);

var _ScoreboardClient = require('./ScoreboardClient');

var _ScoreboardClient2 = _interopRequireDefault(_ScoreboardClient);

var _GameData = require('../models/GameData');

var _GameData2 = _interopRequireDefault(_GameData);

var _ScoreboardFilter = require('../../filters/data/ScoreboardFilter.js');

var _ScoreboardFilter2 = _interopRequireDefault(_ScoreboardFilter);

var _Constants = require('../../constants/Constants');

var _Constants2 = _interopRequireDefault(_Constants);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var GameDataClient = function () {
  function GameDataClient() {
    _classCallCheck(this, GameDataClient);

    this.scoreboardClient = new _ScoreboardClient2.default();
    this.boxScoreClient = new _BoxScoreClient2.default();
    this.playByPlayClient = new _PlayByPlayClient2.default();
  }

  _createClass(GameDataClient, [{
    key: 'fetchDataForDateRange',
    value: function fetchDataForDateRange(startDate, endDate, callback) {
      var transformedStartDate = startDate.clone().tz(_Constants2.default.DEFAULT_TIMEZONE);
      var transformedEndDate = endDate.clone().tz(_Constants2.default.DEFAULT_TIMEZONE);
      var startDateUnixTimestampMilliseconds = transformedStartDate.valueOf();
      var endDateUnixTimestampMilliseconds = transformedEndDate.valueOf();
      var promises = [];
      for (var currentDate = startDate; currentDate.isBefore(endDate); currentDate.add(1, 'days')) {
        promises.push(this.fetchDataForDate(currentDate, startDateUnixTimestampMilliseconds, endDateUnixTimestampMilliseconds));
      }
      return _q2.default.all(promises);
    }
  }, {
    key: 'fetchDataForDate',
    value: function fetchDataForDate(date, startDateUnixTimestampMilliseconds, endDateUnixTimestampMilliseconds) {
      var _this = this;

      var filteredScoreboardData = {};
      var playByPlay = {};
      var boxScore = {};
      var gameData = {};
      var formattedDate = GameDataClient.generateCustomFormattedDate(date);
      return this.scoreboardClient.fetch(formattedDate).then(function (scoreboardData) {
        filteredScoreboardData = _ScoreboardFilter2.default.filter(scoreboardData, startDateUnixTimestampMilliseconds, endDateUnixTimestampMilliseconds);
        return filteredScoreboardData;
      }).then(function (scoreboardData) {
        return _this.fetchPlayByPlayData(filteredScoreboardData, playByPlay);
      }).then(function (playByPlayData) {
        return _this.fetchBoxScoreData(filteredScoreboardData, boxScore);
      }).then(function (boxScoreData) {
        for (var gameId in filteredScoreboardData) {
          gameData[gameId] = new _GameData2.default({
            metadata: filteredScoreboardData[gameId].metadata,
            scores: filteredScoreboardData[gameId].scores,
            boxScoreLeaders: boxScore[gameId],
            playByPlay: playByPlay[gameId]
          });
        }
        return gameData;
      }).then(function (data) {
        return gameData;
      });
    }
  }, {
    key: 'fetchPlayByPlayData',
    value: function fetchPlayByPlayData(filteredGameData, playByPlay) {
      var _this2 = this;

      var promises = [];

      var _loop = function _loop(gameId) {
        var gameData = filteredGameData[gameId];
        if (gameData.metadata.hasStarted()) {
          var formattedGameDate = gameData.metadata.getNbaStatsFormattedStartDate();
          promises.push(_this2.playByPlayClient.fetch(formattedGameDate, gameId).then(function (data) {
            return playByPlay[gameId] = data;
          }));
        }
      };

      for (var gameId in filteredGameData) {
        _loop(gameId);
      };
      return _q2.default.all(promises);
    }
  }, {
    key: 'fetchBoxScoreData',
    value: function fetchBoxScoreData(filteredGameData, boxScore) {
      var _this3 = this;

      var promises = [];

      var _loop2 = function _loop2(gameId) {
        var gameData = filteredGameData[gameId];
        if (gameData.metadata.hasStarted()) {
          var formattedGameDate = gameData.metadata.getNbaStatsFormattedStartDate();
          promises.push(_this3.boxScoreClient.fetch(formattedGameDate, gameId).then(function (data) {
            return boxScore[gameId] = data;
          }));
        }
      };

      for (var gameId in filteredGameData) {
        _loop2(gameId);
      };
      return _q2.default.all(promises);
    }
  }], [{
    key: 'generateCustomFormattedDate',
    value: function generateCustomFormattedDate(date) {
      return date.clone().tz(_Constants2.default.DEFAULT_TIMEZONE).format(_Constants2.default.DEFAULT_DATE_FORMAT);
    }
  }]);

  return GameDataClient;
}();

exports.default = GameDataClient;